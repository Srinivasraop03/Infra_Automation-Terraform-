name: Review App (Ephemeral Environment)

on:
    pull_request:
        types: [opened, synchronize, reopened, closed]

env:
    TF_LOG: INFO
    AWS_REGION: us-east-1

jobs:
    deploy-review:
        name: "Deploy Review App"
        if: github.event.action != 'closed'
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: ./infrastructure-live

        steps:
            - name: Checkout Code
              uses: actions/checkout@v3

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v2
              with:
                  terraform_version: 1.5.7
                  terraform_wrapper: false

            - name: Configure AWS Credentials
              uses: aws-actions/configure-aws-credentials@v2
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: ${{ env.AWS_REGION }}

            - name: Terraform Init
              run: terraform init

            - name: Select Workspace
              id: workspace
              run: |
                  WORKSPACE="pr-${{ github.event.number }}"
                  echo "Selecting workspace: $WORKSPACE"
                  terraform workspace select $WORKSPACE || terraform workspace new $WORKSPACE

            - name: Terraform Validate
              run: terraform validate

            - name: Terraform Plan
              id: plan
              env:
                  TF_VAR_environment: "pr-${{ github.event.number }}"
                  TF_VAR_vpc_cidr: "10.200.0.0/16"
                  TF_VAR_azs_count: 2
                  TF_VAR_single_nat_gateway: true
                  TF_VAR_cluster_name: "pr-${{ github.event.number }}-cluster"
                  TF_VAR_instance_count: 1
                  TF_VAR_instance_type: "t3.micro"
                  TF_VAR_allowed_ssh_cidrs: '["127.0.0.1/32"]'
                  TF_VAR_bucket_name: "pr-${{ github.event.number }}-bucket-srini"
              run: |
                  terraform plan -out=tfplan -input=false

            - name: Terraform Apply
              if: github.ref != 'refs/heads/main'
              env:
                  TF_VAR_environment: "pr-${{ github.event.number }}"
                  TF_VAR_vpc_cidr: "10.200.0.0/16"
                  TF_VAR_azs_count: 2
                  TF_VAR_single_nat_gateway: true
                  TF_VAR_cluster_name: "pr-${{ github.event.number }}-cluster"
                  TF_VAR_instance_count: 1
                  TF_VAR_instance_type: "t3.micro"
                  TF_VAR_allowed_ssh_cidrs: '["127.0.0.1/32"]'
                  TF_VAR_bucket_name: "pr-${{ github.event.number }}-bucket-srini"
              run: |
                  terraform apply -auto-approve -input=false tfplan

            - name: Comment on PR
              uses: actions/github-script@v6
              if: success()
              with:
                  script: |
                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: 'üöÄ Review App Deployed! Workspace: pr-${{ github.event.number }}'
                      })

    destroy-review:
        name: "Destroy Review App"
        if: github.event.action == 'closed'
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: ./infrastructure-live

        steps:
            - name: Checkout Code
              uses: actions/checkout@v3

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v2
              with:
                  terraform_version: 1.5.7

            - name: Configure AWS Credentials
              uses: aws-actions/configure-aws-credentials@v2
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: ${{ env.AWS_REGION }}

            - name: Terraform Init
              run: terraform init

            - name: Select Workspace
              run: |
                  WORKSPACE="pr-${{ github.event.number }}"
                  echo "Selecting workspace: $WORKSPACE"
                  # Only destroy if workspace exists
                  if terraform workspace select $WORKSPACE; then
                    echo "Workspace exists. Proceeding to destroy."
                  else
                    echo "Workspace does not exist. Skipping."
                    exit 0
                  fi

            - name: Terraform Destroy
              env:
                  TF_VAR_environment: "pr-${{ github.event.number }}"
                  TF_VAR_vpc_cidr: "10.200.0.0/16"
                  TF_VAR_azs_count: 2
                  TF_VAR_single_nat_gateway: true
                  TF_VAR_cluster_name: "pr-${{ github.event.number }}-cluster"
                  TF_VAR_instance_count: 1
                  TF_VAR_instance_type: "t3.micro"
                  TF_VAR_allowed_ssh_cidrs: '["127.0.0.1/32"]'
                  TF_VAR_bucket_name: "pr-${{ github.event.number }}-bucket-srini"
              run: |
                  terraform destroy -auto-approve -input=false

            - name: Delete Workspace
              run: |
                  terraform workspace select default
                  terraform workspace delete "pr-${{ github.event.number }}"

            - name: Comment on PR
              uses: actions/github-script@v6
              with:
                  script: |
                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: 'üóëÔ∏è Review App Destroyed.'
                      })
